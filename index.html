<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>AI PMS Investor Dashboard</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;background:#0b0f14;color:#e6edf3;}
header{padding:16px 24px;background:#111821;border-bottom:1px solid #1f2a36;}
h1{margin:0;font-size:20px;}
.container{padding:20px;max-width:1200px;margin:auto;}
.section{background:#111821;margin-bottom:20px;padding:16px;border-radius:10px;border:1px solid #1f2a36;}
.grid{display:grid;gap:16px;}
.grid-2{grid-template-columns:repeat(auto-fit,minmax(320px,1fr));}
table{width:100%;border-collapse:collapse;font-size:13px;}
th,td{padding:8px;border-bottom:1px solid #1f2a36;text-align:left;}
footer{text-align:center;font-size:12px;padding:20px;opacity:.7;}
.chart-box{height:260px;}
.kpi{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-bottom:12px;}
.kpi div{background:#0f1620;padding:10px;border-radius:8px;border:1px solid #1f2a36;font-size:12px;}

.buy{color:#00e676;font-weight:bold;}
.sell{color:#ff5252;font-weight:bold;}
.hold{color:#4fc3f7;font-weight:bold;}
.wait{color:#ffd740;font-weight:bold;}

.star{cursor:pointer;color:#9aa7b3;}
.star:hover{color:#ffd700;}

.modal{position:fixed;inset:0;background:#0008;display:none;align-items:center;justify-content:center;}
.modal-box{background:#111821;padding:20px;border-radius:10px;max-width:420px;border:1px solid #1f2a36;}
</style>
</head>

<body>

<header><h1>AI PMS Investor Dashboard</h1></header>

<div class="container">

<!-- KPI + NAV -->
<div class="section">
<div class="kpi" id="kpiStrip"></div>
<div class="chart-box"><canvas id="navChart"></canvas></div>
</div>

<!-- PORTFOLIO -->
<div class="section">
<h2>Portfolio Snapshot (Dynamic Positions)</h2>
<table id="portfolioTable"></table>
</div>

<!-- WATCHLIST -->
<div class="section grid grid-2">
<div>
<h2>Current Signals / Watchlist</h2>
<table id="signalsTable"></table>
</div>
<div>
<h2>Past Watchlist / Exit Ledger</h2>
<table id="pastTable"></table>
</div>
</div>

<!-- RISK -->
<div class="section">
<h2>Risk Metrics & Stability Matrix</h2>
<table id="riskTable"></table>
</div>

<!-- REBALANCE -->
<div class="section">
<h2>Rebalance Governance</h2>
<p id="rebalanceText"></p>
</div>

<!-- CIO -->
<div class="section">
<h2>CIO Commentary</h2>
<div id="cioText"></div>
</div>

</div>

<footer>
<div id="timestamp"></div>
© Pravash Dash
</footer>

<!-- MODAL -->
<div class="modal" id="modal">
<div class="modal-box">
<div id="modalText"></div>
<br><button onclick="modal.style.display='none'">Close</button>
</div>
</div>

<script>
const BASE="/alpha-engine-live/output/";

async function loadAll(){
  const files=[
    "dashboard_data.json",
    "prices_live.json",
    "portfolio_positions.json",
    "watchlist_history.csv"
  ];

  const res=await Promise.all(files.map(f=>fetch(BASE+f).then(r=>r.ok?r.json?.():null).catch(()=>null)));
  return {
    dash:res[0]||{},
    prices:res[1]||{},
    positions:res[2]||[],
  };
}

function renderKPI(d){
  const start=d.equity_values?.[0]||0;
  const end=d.equity_values?.at(-1)||0;
  const ret=start?(((end-start)/start)*100).toFixed(2):"0";

  const kpis=[
    ["Current NAV",end],
    ["Return %",ret],
    ["Max DD %",d.max_drawdown_pct],
    ["Volatility %",d.volatility_pct],
    ["Sharpe",d.sharpe],
    ["Regime",d.regime]
  ];

  kpiStrip.innerHTML=kpis.map(k=>`<div><b>${k[0]}</b><br>${k[1]??""}</div>`).join("");
}

let chart;
function renderChart(d){
  if(chart)chart.destroy();
  chart=new Chart(navChart,{
    type:"line",
    data:{
      labels:d.equity_dates,
      datasets:[
        {label:"Model Equity",data:d.equity_values},
        {label:"Nifty 50",data:d.nifty_values}
      ]
    },
    options:{responsive:true,maintainAspectRatio:false}
  });
}

function renderPortfolio(positions, prices){
  if(!positions?.length){portfolioTable.innerHTML="<tr><td>No positions</td></tr>";return;}

  const total=positions.reduce((s,p)=>s+(p.qty*(prices[p.ticker]||0)),0);

  let h="<tr><th>Ticker</th><th>Qty</th><th>Live</th><th>Value</th><th>Weight%</th></tr>";

  positions.forEach(p=>{
    const price=prices[p.ticker]||0;
    const val=p.qty*price;
    const w=total?((val/total)*100).toFixed(2):"";

    h+=`<tr>
      <td>${p.ticker}</td>
      <td>${p.qty}</td>
      <td>${price}</td>
      <td>${val.toFixed(0)}</td>
      <td>${w}</td>
    </tr>`;
  });

  portfolioTable.innerHTML=h;
}

function renderSignals(trades, prices){
  if(!trades?.length){signalsTable.innerHTML="<tr><td>No signals</td></tr>";return;}

  let h="<tr><th>Ticker</th><th>Live</th><th>Signal</th><th>*</th></tr>";

  trades.forEach(t=>{
    const cls=t.signal.toLowerCase();
    h+=`<tr>
      <td>${t.ticker}</td>
      <td>${prices[t.ticker]||""}</td>
      <td class="${cls}">${t.signal}</td>
      <td class="star" onclick="showReason('${t.reason||"No explanation available"}')">★</td>
    </tr>`;
  });

  signalsTable.innerHTML=h;
}

function renderRisk(d){
  const rows=[
    ["Regime",d.regime,"Model risk state"],
    ["Volatility %",d.volatility_pct,"Realized vol"],
    ["Sharpe",d.sharpe,"Risk-adjusted return"],
    ["Max Drawdown %",d.max_drawdown_pct,"Peak loss"]
  ];

  riskTable.innerHTML="<tr><th>Metric</th><th>Value</th><th>Explainability</th></tr>"+
    rows.map(r=>`<tr><td>${r[0]}</td><td>${r[1]??""}</td><td>${r[2]}</td></tr>`).join("");
}

function renderRebalance(d){
  const next=new Date(d.next_rebalance);
  const days=Math.ceil((next-new Date())/86400000);
  rebalanceText.innerText=`Last: ${d.last_rebalance} | Next: ${d.next_rebalance} | Countdown: ${days} days`;
}

function showReason(t){
  modal.style.display="flex";
  modalText.innerText=t;
}

async function init(){
  const {dash,prices,positions}=await loadAll();

  renderKPI(dash);
  renderChart(dash);
  renderPortfolio(positions,prices);
  renderSignals(dash.trades,prices);
  renderRisk(dash);
  renderRebalance(dash);

  cioText.innerText=dash.cio_commentary||"AI CIO narrative unavailable.";
  timestamp.innerText="Last Updated: "+new Date().toLocaleString();
}

init();
setInterval(init,300000);
</script>

</body>
</html>
