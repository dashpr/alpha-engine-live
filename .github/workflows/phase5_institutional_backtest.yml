name: Phase-5 Institutional Backtest

on:
  workflow_dispatch:
  schedule:
    - cron: "30 0 * * 0"

jobs:
  phase5:
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ai-pms

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # --------------------------------------------------
      # STEP-1: Show repo structure (truth check)
      # --------------------------------------------------
      - name: Show repo tree
        run: |
          echo "===== REPO ROOT ====="
          ls -R
          echo "===== AI-PMS FOLDER ====="
          ls -R .

      # --------------------------------------------------
      # STEP-2: Download historical data
      # --------------------------------------------------
      - name: Download NSE Historical Data
        run: python backtest/engines/nse_downloader.py

      # --------------------------------------------------
      # STEP-3: Run Phase-5 backtest (must not fail silently)
      # --------------------------------------------------
      - name: Run Phase-5 Backtest
        run: |
          set -e
          python backtest/run_phase5_backtest.py

      # --------------------------------------------------
      # STEP-4: Verify outputs exist (hard check)
      # --------------------------------------------------
      - name: Verify Phase-5 outputs
        run: |
          echo "===== CHECKING OUTPUT DIRECTORY ====="
          ls -R data || true

          if [ ! -d "data/output/phase5" ]; then
            echo "❌ Phase-5 output folder missing"
            exit 1
          fi

          if [ -z "$(ls -A data/output/phase5)" ]; then
            echo "❌ Phase-5 output folder empty"
            exit 1
          fi

          echo "✅ Phase-5 outputs verified"

      # --------------------------------------------------
      # STEP-5: Upload artifacts
      # --------------------------------------------------
      - name: Upload Phase-5 outputs
        uses: actions/upload-artifact@v4
        with:
          name: ai-pms-phase5-results
          path: ai-pms/data/output/phase5/
